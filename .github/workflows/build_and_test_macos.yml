name: macOS build and test

on: [push]

jobs:
  build_homebrew:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check commit message
      id: check_commit
      run: |
        commit_message=$(git log --format=%B -n 1 ${{ github.event.after }})
        if [[ "${commit_message}" == *"notest"* ]]; then
          echo "Commit contains 'notest'. Skipping tests."
          echo "SKIP=true" >> $GITHUB_ENV
        else
          echo "SKIP=false" >> $GITHUB_ENV
        fi
    - name: brew update
      run: brew update
      if: env.SKIP != 'true'
    - name: Install gcc/gfortran
      run: brew reinstall gcc
      if: env.SKIP != 'true'
    - name: Install xquartz
      run: brew install --cask xquartz
      if: env.SKIP != 'true'
    - name: Install shellcheck
      run: brew install shellcheck
      if: env.SKIP != 'true'
    - name: Collect debug info
      run: |
        which gfortran
        brew info libx11
        ls -l /opt/homebrew/include/X11
        echo "Find GCC compiler"
        lib/find_gcc_compiler.sh
        echo "Find FORTRAN compiler"
        lib/find_fortran_compiler.sh
      if: env.SKIP != 'true'
    - name: make VaST (Homebrew)
      run: make
      if: env.SKIP != 'true'
    - name: Shellcheck VaST BASH scripts
      run: |
        for i in lib/*sh util/*sh util/transients/*sh util/examples/*sh; do
          shellcheck --severity=error $i
        done
      if: env.SKIP != 'true'

  build_macports:
    needs: build_homebrew
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check commit message
      id: check_commit
      run: |
        commit_message=$(git log --format=%B -n 1 ${{ github.event.after }})
        if [[ "${commit_message}" == *"notest"* ]]; then
          echo "Commit contains 'notest'. Skipping tests."
          echo "SKIP=true" >> $GITHUB_ENV
        else
          echo "SKIP=false" >> $GITHUB_ENV
        fi
    - name: Install MacPorts
      run: |
        curl -LO https://raw.githubusercontent.com/GiovanniBussi/macports-ci/master/macports-ci
        source ./macports-ci install
      if: env.SKIP != 'true'
    - name: port upgrade outdated
      run: sudo port upgrade outdated
      if: env.SKIP != 'true'
    - name: Install gcc, g++, gfortran, and wget
      run: sudo port install gcc13 wget
      if: env.SKIP != 'true'
    - name: Install X11 header files
      run: sudo port install xorg-libX11
      if: env.SKIP != 'true'
    - name: Install libpng
      run: sudo port install libpng
      if: env.SKIP != 'true'
    - name: make VaST (MacPorts)
      run: make
      if: env.SKIP != 'true'

  test_macports:
    needs: build_macports
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check commit message
      id: check_commit
      run: |
        commit_message=$(git log --format=%B -n 1 ${{ github.event.after }})
        if [[ "${commit_message}" == *"notest"* ]]; then
          echo "Commit contains 'notest'. Skipping tests."
          echo "SKIP=true" >> $GITHUB_ENV
        else
          echo "SKIP=false" >> $GITHUB_ENV
        fi
    - name: Install MacPorts
      run: |
        curl -LO https://raw.githubusercontent.com/GiovanniBussi/macports-ci/master/macports-ci
        source ./macports-ci install
      if: env.SKIP != 'true'
    - name: Install gcc, g++, gfortran, and wget
      run: sudo port install gcc13 wget
      if: env.SKIP != 'true'
    - name: Install X11 header files
      run: sudo port install xorg-libX11
      if: env.SKIP != 'true'
    - name: Install libpng
      run: sudo port install libpng
      if: env.SKIP != 'true'
    - name: Install ghostscript
      run: sudo port install ghostscript
      if: env.SKIP != 'true'
    - name: Install shellcheck
      run: sudo port install shellcheck
      if: env.SKIP != 'true'
    - name: Install Selenium + requests (Python)
      run: |
        pip3 install --upgrade selenium requests
        python3 -c "import selenium; print(selenium.__version__)"
        python3 -c "import requests; print(requests.__version__)"
      if: env.SKIP != 'true'
    - name: Verify Chrome availability for Selenium tests
      run: |
        # macOS runners have Chrome pre-installed
        /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --version || echo "Chrome version check"
        # Selenium 4.6+ has built-in Selenium Manager that auto-downloads ChromeDriver
      if: env.SKIP != 'true'
    - name: make VaST
      run: make
      if: env.SKIP != 'true'
    - name: Shellcheck VaST BASH scripts
      run: |
        for i in lib/*sh util/*sh util/transients/*sh util/examples/*sh; do
          shellcheck --severity=error $i
        done
      if: env.SKIP != 'true'
    - name: prepare for the test
      run: echo "1" > ../THIS_IS_HPCC 
      if: env.SKIP != 'true'
    - name: test VaST
      run: util/examples/test_vast.sh
      if: env.SKIP != 'true'
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts-macos
        path: test_artifacts/
        retention-days: 7
      if: env.SKIP != 'true'
