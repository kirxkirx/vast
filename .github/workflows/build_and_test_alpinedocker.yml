name: Alpine Docker build + VaST system test

on:
  schedule:
    - cron: '0 2 * * 0'   # weekly, Sundays 02:00 UTC (same cadence style as macOS workflow) 
  workflow_dispatch:

jobs:
  build_and_test_alpine_docker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build VaST Alpine Docker image
        run: |
          docker build -t vast-alpine:ci -f - . <<'DOCKERFILE'
          FROM alpine:latest

          # Base build deps (mirrors your alpine container build list, plus what test_vast.sh commonly needs)
          RUN apk add --no-cache \
                bash \
                gcc g++ gfortran make musl-dev \
                libx11-dev libpng-dev \
                git curl wget file bc \
                ghostscript \
                python3 py3-pip py3-setuptools py3-wheel \
                chromium chromium-chromedriver

          # Some tests expect "python" to exist
          RUN ln -sf /usr/bin/python3 /usr/bin/python

          WORKDIR /opt/vast
          COPY . /opt/vast

          # Python deps used by parts of the test suite (Ubuntu workflow installs these via pip)
          RUN pip3 install --no-cache-dir --break-system-packages \
                astropy sympy \
                -r util/comet_finder/requirements.txt \
                selenium requests

          # Build VaST inside the image
          RUN make

          DOCKERFILE

      - name: Syntax-check the test script
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE:/work" -w /work vast-alpine:ci \
            bash -lc 'bash -n util/examples/test_vast.sh'

      - name: Run VaST system test inside Alpine container
        env:
          TEST_VAST_CURL_PROXY: ${{ secrets.TEST_VAST_CURL_PROXY }}
        timeout-minutes: 300
        run: |
          rm -rf test_artifacts
          mkdir -p test_artifacts

          docker run --rm \
            -e TEST_VAST_CURL_PROXY \
            -e GITHUB_ACTIONS \
            -v "$GITHUB_WORKSPACE:/out" \
            -w /opt/vast \
            vast-alpine:ci \
            bash -lc '
              echo "1" > ../THIS_IS_HPCC
              mkdir -p test_artifacts /out/test_artifacts
              util/examples/test_vast.sh 2>&1 | tee test_artifacts/test_vast_full_output.log /out/test_artifacts/test_vast_full_output.log
              TEST_EXIT_CODE=${PIPESTATUS[0]}
              # copy artifacts to the runner workspace for upload
              cp vast_test_incremental_list_of_failed_test_codes.txt test_artifacts/ 2>/dev/null || true
              if [ -d test_artifacts ]; then
                rm -rf /out/test_artifacts
                cp -a test_artifacts /out/
              fi
              exit $TEST_EXIT_CODE
            '

      - name: Copy artifacts from container on failure
        if: always()
        run: |
          # In case the docker run was killed before copying artifacts,
          # the tee log on the host side (via volume mount) may still be available.
          # Ensure the directory exists for the upload step.
          mkdir -p test_artifacts

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-alpine
          path: test_artifacts/
          retention-days: 7
        if: always()
